<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE-edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
        type="application/javascript"></script>
  <title>Document</title>
  <script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script>
  <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

</head>
<body>
  <p id="content">Please connect your wallet.</p>
  <button onclick="connectWallet()">Connect Wallet</button>
  <br>
  <p id="ethBalance">Eth Balance: 0</p>
  <p id="daiBalance">Dai Balance: 0</p>
  <button onclick="retrieveBalance()">Get Current Balance</button>
  <button onclick="getBalanceEth()">Get Current Balance In USD</button>
  <br>
  <br>
  <input id="depositEthAmount"></input>
  <button onclick="depositEth()">Store Eth</button>
  <br>
  <br>
  <input id="withdrawEthAmount"></input>
  <button onclick="withdrawEth()">Withdraw Eth</button>
  <br>
  <br>
  <input id="depositDaiAmount"></input>
  <button onclick="depositDai()">Store Dai</button>
  <br>
  <br>
  <input id="withdrawDaiAmount"></input>
  <button onclick="withdrawDai()">Withdraw DAI</button>
  <br>
  <script>
    var contractAddress     = '0x0D961916e94Fb1D5Ab7c52e34Ce36d64Ebe7c00D';
    var contractABI         = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"depositDai","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"depositEth","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"getter","type":"address"}],"name":"getBalanceDai","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"getter","type":"address"}],"name":"getBalanceEth","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestPriceDai","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestPriceEth","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawDai","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawEth","outputs":[],"stateMutability":"nonpayable","type":"function"}];
    const provider          = new ethers.providers.Web3Provider(window.ethereum);
    async function connectWallet () {
      ethereum.request({method: 'eth_requestAccounts'}).catch((e) => {
        console.log(e);
      }).then(async () => {
        const signer = provider.getSigner();
        const address = ethereum.selectedAddress;
        const userBalance = await provider.getBalance(address);
        $("#content").text(ethers.utils.formatEther(userBalance));
      })
    }

    async function retrieveBalance () {
      ethereum.request({method: 'eth_requestAccounts'}).catch((e) => {
        console.log(e);
      }).then(async () => {
        const address = ethereum.selectedAddress;
        const contract = new ethers.Contract(contractAddress, contractABI, provider);
        // console.log(await contract.getBalanceEth(address));
        console.log(ethers.utils.formatEther(await contract.getBalanceEth(address)));
        $("#ethBalance").text('Dai Balance: '+ethers.utils.formatEther(await contract.getBalanceEth(address), 18) + ' Dai');
        $("#daiBalance").text('Eth Balance: '+formatUnits(contract.getBalanceDai(address), 18) + ' Eth');
      })
    }

    async function depositEth () {
      ethereum.request({method: 'eth_requestAccounts'}).catch((e) => {
        console.log(e);
      }).then(async () => {
        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, contractABI, provider);
        const connectedContract = contract.connect(signer);
        // console.log($("#depositEthAmount").val());
        let store = await connectedContract.depositEth({value: ethers.utils.parseEther($("#depositEthAmount").val())});
      })
    }

    async function withdrawEth () {
      ethereum.request({method: 'eth_requestAccounts'}).catch((e) => {
        console.log(e);
      }).then(async () => {
        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, contractABI, provider);
        const connectedContract = contract.connect(signer);
        let store = await connectedContract.withdrawEth(ethers.utils.parseEther($("#withdrawEthAmount").val()));
      })
    }

    async function depositDai () {
      ethereum.request({method: 'eth_requestAccounts'}).catch((e) => {
        console.log(e);
      }).then(async () => {
        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, contractABI, provider);
        const connectedContract = contract.connect(signer);
        let store = await connectedContract.depositDai(ethers.utils.parseUnits($("#depositDaiAmount").val(), 18));
      })
    }

    async function withdrawDai () {
      ethereum.request({method: 'eth_requestAccounts'}).catch((e) => {
        console.log(e);
      }).then(async () => {
        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, contractABI, provider);
        const connectedContract = contract.connect(signer);
        let store = await connectedContract.withdrawDai(ethers.utils.parseUnits($("#withdrawDaiAmount").val(), 18));
      })
    }

    async function getBalanceEth () {
      ethereum.request({method: 'eth_requestAccounts'}).catch((e) => {
        console.log(e);
      }).then(async () => {
        var address         = ethereum.selectedAddress;
        var contract        = new ethers.Contract(contractAddress, contractABI, provider);
        var ethRate         = await contract.getLatestPriceEth();
        console.log(formatEth(ethRate));
        var daiRate         = await contract.getLatestPriceDai();
        var formattedEth    = formatEth(await contract.getBalanceEth(address));
        // var formattedDai    = formatUnits(contract.getBalanceDai(address))
        var ethusd          = formatUnits(ethRate, 8) * formattedEth;
        // var daiusd          = formatUnits(daiRate, 8) * formattedDai;
        $("#ethBalance").text('Eth Balance: '+formattedEth+' Eth'+' / '+ethusd);
        // $("#daiBalance").text('Dai Balance: ' + formattedDai + ' Dai' + ' / ' + daiusd + '$');
      })
    }

    function formatEth(amount)
    {
        return ethers.utils.formatEther(amount);
    }

    function formatUnits(amount)
    {
        return ethers.utils.formatUnits(amount);
    }
  </script>
</body>